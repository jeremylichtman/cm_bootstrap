<?php

define("CMB_CVL_PLACEHOLDER_IMG", "data:image/gif;base64,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");

// Require Helpers
require_once(drupal_get_path('module', 'cc_helper') . '/lib/ImageHelper.php');
require_once(drupal_get_path('module', 'cc_helper') . '/lib/FieldHelper.php');
require_once(drupal_get_path('module', 'cc_helper') . '/lib/ColorHelper.php');
require_once(drupal_get_path('module', 'cc_helper') . '/lib/ParagraphHelper.php');
require_once(drupal_get_path('module', 'cc_helper') . '/lib/LinkHelper.php');

/**
 * Implements hook_theme($existing, $type, $theme, $path).
 */
function cmb_custom_video_list_theme($existing, $type, $theme, $path) {
  $theme = array();
  // Full
  $theme['paragraphs_item__custom_video_list'] = array(
    'template' => 'paragraphs-item--custom-video-list',
    'path' => drupal_get_path('module', 'cmb_custom_video_list') . '/templates',
  );
  // Paragraphs editor preview
  $theme['paragraphs_item__custom_video_list__paragraphs_editor_preview'] = array(
    'template' => 'paragraphs-item--custom-video-list--paragraphs_editor_preview',
    'path' => drupal_get_path('module', 'cmb_custom_video_list') . '/templates',
  );
  return $theme;
}

/**
 * Implements hook_preprocess_entity(&$variables).
 */
function cmb_custom_video_list_preprocess_entity(&$variables) {
	if ($variables['entity_type'] == 'paragraphs_item' && $variables['elements']['#bundle'] == 'custom_video_list') {
  	$paragraph = $variables['paragraphs_item'];

  	switch($variables['view_mode']) {

      case 'paragraphs_editor_preview':
        $data = array(
          'id' => $paragraph->item_id,
        );
        break;

      case 'full':
        // Attach CSS
        drupal_add_css(drupal_get_path('module', 'cmb_custom_video_list') . '/css/cmb_custom_video_list.css');
        // Attach JS
        drupal_add_js(drupal_get_path('module', 'cmb_custom_video_list') . '/js/cmb_custom_video_list.js',
          array('scope' => 'footer', 'weight' => -5)
        );
        // Attach Flexloader
        libraries_load('flexloader');

        // Colors
        $vs_heading_bg_color_1 = 'black';
        $vs_heading_text_color = 'white';
        $vs_heading_overlay_text_color = 'white';

        if (module_exists('cm_bootstrap_cp_colors')) {
          $colors = cm_bootstrap_cp_colors_get();

          if (isset($colors['vs_heading_bg_color_1'])) {
            $vs_heading_bg_color_1 = $colors['vs_heading_bg_color_1'];
          }

          if (isset($colors['vs_heading_text_color'])) {
            $vs_heading_text_color = $colors['vs_heading_text_color'];
          }
        }

        // Paragraph-level color overrides.
        if (isset($paragraph->field_cc_cvl_bg_color[LANGUAGE_NONE])) {
          $vs_heading_bg_color_1 = \ContentComponents\Helper\ColorHelper::jqueryColorPicker($paragraph, 'field_cc_cvl_bg_color');
        }

        if (isset($paragraph->field_cc_cvl_heading_color[LANGUAGE_NONE])) {
          $vs_heading_text_color = \ContentComponents\Helper\ColorHelper::jqueryColorPicker($paragraph, 'field_cc_cvl_heading_color');
        }

        if (isset($paragraph->field_cc_cvl_text_color[LANGUAGE_NONE])) {
          $vs_heading_overlay_text_color = \ContentComponents\Helper\ColorHelper::jqueryColorPicker($paragraph, 'field_cc_cvl_text_color');
        }

        // Nid
        $nid = FALSE;
        if (isset($paragraph->field_cc_cvl_er[LANGUAGE_NONE])) {
          $nid = $paragraph->field_cc_cvl_er[LANGUAGE_NONE][0]['target_id'];
        }

        if ($node = node_load($nid)) {
          // Placeholder image
          $placeholder_img = CMB_CVL_PLACEHOLDER_IMG;

          /*if (module_exists('cm_bootstrap_cp_default_images')) {
            $p_file = cm_bootstrap_cp_default_images_load_image('cm_show');
            if ($p_file) {
              $p_image_uri = $p_file->uri;
              $placeholder_img = image_style_url('500x281', $p_image_uri);
            }
          }
          */

          // Get shows and series nodes.
          if (isset($node->field_videos_to_highlight[LANGUAGE_NONE])) {
            foreach($node->field_videos_to_highlight[LANGUAGE_NONE] as $item) {
              $ref_nids[] = $item['target_id'];
            }

            foreach($ref_nids as $ref_nid) {
              $ref_node_object = node_load($ref_nid);
              $ref_nodes[] = $ref_node_object;
            }

            foreach($ref_nodes as $ref_node) {
              switch($ref_node->type) {
                case 'cm_show':

                  // Use show custom thumbnail field if availABLE.
                  if (isset($ref_node->field_show_custom_thumbnail[LANGUAGE_NONE])) {
                    $image_uri = $ref_node->field_show_custom_thumbnail[LANGUAGE_NONE][0]['uri'];
                  }
                  // Otherwise, get the VOD thumbnail uri, if possible.
                  else if (module_exists('cmb_helper')) {
                    // Get a default uri.
                    $default_image_uri = null;
                    if (isset($ref_node->field_series_image[LANGUAGE_NONE])) {
                      $default_image_uri = $ref_node->field_series_image[LANGUAGE_NONE][0]['uri'];
                    }

                    // Obtain the uri.
                    $image_uri = cmb_helper_vod_thumbnail_uri($ref_node, $default_image_uri);
                  }

                  if (!is_null($image_uri)) {
                    $img_src = image_style_url('500x281', $image_uri);
                  }
                  else {
                    $img_src = '';
                  }

                  // Description
                  $description = FALSE;
                  $allowable_tags = '<i>';
                  if (isset($ref_node->field_description[LANGUAGE_NONE])) {
                    $description = strip_tags($ref_node->field_description[LANGUAGE_NONE][0]['value'], $allowable_tags);
                    $description = cmb_helper_truncate($description, $length = 125, array('html' => true, 'ending' => ' . . .', 'exact' => FALSE));
                  }

                  // Series title
                  $series_title = FALSE;
                  if (isset($ref_node->og_group_ref[LANGUAGE_NONE])) {
                    $nid = $ref_node->og_group_ref[LANGUAGE_NONE][0]['target_id'];
                    $series_title = db_query("SELECT title FROM {node} WHERE nid = :nid", array(':nid' => $nid))->fetchField();
                  }

                  // Data
                  $ref_node_data[] = array(
                    'nid' => $ref_node->nid,
                    'title' => $ref_node->title,
                    'description' => $description,
                    'series_title' => $series_title,
                    'type' => $ref_node->type,
                    'img_src' => $img_src,
                    'placeholder_img' => $placeholder_img,
                    'url' => url('node/' . $ref_node->nid),
                  );
                  break;

                case 'cm_project':
                  // Description
                  $description = FALSE;
                  $allowable_tags = '<i>';
                  if (isset($ref_node->field_description[LANGUAGE_NONE])) {
                    $description = strip_tags($ref_node->field_description[LANGUAGE_NONE][0]['value'], $allowable_tags);
                    $description = cmb_helper_truncate($description, $length = 125, array('html' => true, 'ending' => ' . . .', 'exact' => FALSE));
                  }

                  // Image
                  $img_src = FALSE;
                  if (isset($ref_node->field_series_image[LANGUAGE_NONE][0]['uri'])) {
                    $img_src = image_style_url('500x281', $ref_node->field_series_image[LANGUAGE_NONE][0]['uri']);
                  }
                  else {
                    if (module_exists('cm_bootstrap_cp_default_images')) {
                      $file = cm_bootstrap_cp_default_images_load_image('cm_project');

                      if ($file) {
                        $image_uri = $file->uri;
                        $img_src = image_style_url('500x281', $image_uri);
                      }
                      else {
                        $img_src = $placeholder_img;
                      }
                    }
                  }

                  $ref_node_data[] = array(
                    'nid' => $ref_node->nid,
                    'title' => $ref_node->title,
                    'description' => $description,
                    'series_title' => FALSE,
                    'type' => $ref_node->type,
                    'img_src' => $img_src,
                    'placeholder_img' => $placeholder_img,
                    'url' => url('node/' . $ref_node->nid),
                  );
                  break;
              }
            }

          }
        }

        // Title Alignment
        $title_align_class = 'text-align-center';

        if (isset($paragraph->field_cc_cvl_title_align[LANGUAGE_NONE])) {
          $title_align_class = 'text-align-' . $paragraph->field_cc_cvl_title_align[LANGUAGE_NONE][0]['value'];
        }

        $data = array(
          'id' => $paragraph->item_id,
          'title' => $node->title,
          'bg_color' => $vs_heading_bg_color_1,
          'text_color' => $vs_heading_text_color,
          'overlay_text_color' => $vs_heading_overlay_text_color,
          'ref_node_data' => $ref_node_data,
          'title_align' => $title_align_class,
        );
        break;
    }

    $variables['custom_video_list'] = $data;
  }
}
